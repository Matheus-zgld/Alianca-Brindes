{% extends "base.html" %}
{% block content %}
<h2>üîë √Årea de Baixa (RH)</h2>
<p style="text-align: center;">Insira o c√≥digo ou use a c√¢mera para dar baixa no brinde.</p>

{% if rh_user %}
<div style="text-align:center; margin-bottom:10px; font-size:0.9em;">
    <strong>Conectado como:</strong> {{ rh_user }}
</div>
{% endif %}

{% if error %}<p class="error">{{ error }}</p>{% endif %}

<div id="reader" style="width: 100%; max-width: 400px; margin: 16px auto;"></div>

<form method="POST" id="manual-form" style="text-align: center;">
    <label for="qr_data" style="display:block; text-align:left; font-weight:600;">Conte√∫do do QR Code</label>
    <input type="text" id="qr_data" name="qr_data" placeholder="Ex: 00000000000:12345" required>
    <button type="submit" class="btn-primary" style="width: 100%; margin-top:8px;">Verificar Brinde</button>
</form>

<!-- Menu de bot√µes RH -->
<div class="btn-group" style="margin-top:20px;">
    <a href="{{ url_for('funcionario_home') }}" class="theme-btn">Acesso Funcion√°rio</a>
    <a href="{{ url_for('rh_logs') }}" class="theme-btn">Ver Logs</a>
    <a href="{{ url_for('rh_funcionarios') }}" class="theme-btn">Verificar Funcion√°rios</a>
    <a href="{{ url_for('rh_logout') }}" class="theme-btn" style="background: #c00;">Sair</a>
</div>

<hr style="border-top: 1px solid var(--primary-color); margin: 20px 0;">

<h3 style="color: var(--primary-color); margin-top: 10px;">‚úÖ Brindes Entregues ({{ resgatados | length }})</h3>

<div class="table-wrap">
    {% if resgatados %}
    <table class="responsive-table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Matr√≠cula</th>
                <th>Data</th>
                <th>Hora</th>
            </tr>
        </thead>
        <tbody>
            {% for func in resgatados %}
            <tr>
                <td data-label="Nome">{{ func.nome_completo }}</td>
                <td data-label="Matr√≠cula">{{ func.matricula }}</td>
                <td data-label="Data">{{ func.data_resgate.split(' ')[0] }}</td>
                <td data-label="Hora">{{ func.data_resgate.split(' ')[1] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: var(--primary-color);">Nenhum brinde foi resgatado ainda.</p>
    {% endif %}
</div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById('qr_data').value = decodedText;
        document.getElementById('manual-form').submit();
        html5QrcodeScanner.clear();
    }

    function onScanFailure(error) {
        // console.error(`Code scan error = ${error}`);
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: {width: 250, height: 250}, facingMode: "environment" },
        false
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
{% endblock %}
